{% extends "base.html" %}

{% block title %}Gerenciar Not√≠cias - Meu Site IA{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" />

<style>
  .noticias-container {
    max-width: 900px;
    margin: 2rem auto;
    padding: 2rem;
    background: #fff;
    border-radius: 1rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    font-family: 'Segoe UI',Arial,sans-serif;
  }
  .noticias-header {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }
  .noticias-header h1 {
    font-size: 1.75rem;
    color: #0d6efd;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .alert-placeholder { margin-bottom: 1rem; }

  /* Formul√°rio de cadastro */
  #form-noticia { display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: end; margin-bottom: 2rem; }
  #form-noticia .field-group { display: flex; flex-direction: column; gap: 0.5rem; }
  #form-noticia input, #form-noticia textarea, #form-noticia select {
    padding: 0.75rem;
    border: 1px solid #ccc;
    border-radius: 0.5rem;
    font-size: 1rem;
  }
  #form-noticia textarea { resize: vertical; min-height: 80px; }
  #btnPreencher {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .spinner-border { margin-left: 0.5rem; }

  /* Tags e SEO (invis√≠veis mas dispon√≠veis) */
  .field-group.hidden { display: none; }

  /* Cards de not√≠cias */
  .noticia-list { display: grid; gap: 1.5rem; }
  .noticia-card {
    display: flex;
    gap: 1rem;
    background: #f8f9fa;
    border-radius: 0.75rem;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }
  .noticia-card img {
    width: 160px;
    height: 100px;
    object-fit: cover;
    border-right: 1px solid #e9ecef;
  }
  .noticia-conteudo {
    padding: 1rem;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }
  .noticia-conteudo h5 {
    margin: 0;
    font-size: 1.1rem;
    color: #333;
  }
  .tags {
    margin: 0.5rem 0;
  }
  .tag { display: inline-block; background: #20c997; color: #fff; padding: 0.2rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; margin-right: 0.25rem; }
  .noticia-conteudo p { flex-grow: 1; color: #555; margin-bottom: 0.5rem; }
  .card-actions { display: flex; gap: 0.5rem; margin-top: auto; }
  .card-actions a, .card-actions button {
    padding: 0.4rem 0.75rem;
    font-size: 0.9rem;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: background 0.3s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
  }
  .btn-access { background: #0d6efd; color: #fff; }
  .btn-access:hover { background: #0b5ed7; }
  .btn-remove { background: #e74c3c; color: #fff; }
  .btn-remove:hover { background: #c0392b; }
  .btn-feature { background: #ffc107; color: #000; }
  .btn-feature.active { background: #fd7e14; }
  .btn-copy { background: #6c757d; color: #fff; }

  /* Feedback visual */
  .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 1080; }
</style>

<div class="noticias-container">
  <div class="noticias-header">
    <h1><i class="fas fa-newspaper"></i> Gerenciar Not√≠cias Curadas</h1>
    <button class="btn-access" onclick="window.location.reload();"><i class="fas fa-sync-alt"></i> Atualizar</button>
  </div>

  <!-- Mensagens de feedback -->
  <div class="alert-placeholder">
    {% with msgs = get_flashed_messages(with_categories=true) %}
      {% if msgs %}
        {% for category, msg in msgs %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <!-- Formul√°rio de cadastro -->
  <form id="form-noticia" method="POST" action="/noticias" autocomplete="off">
    <div class="field-group">
      <label for="url">üîó Link da Not√≠cia</label>
      <input type="url" name="url" id="url" placeholder="Cole a URL (https://...)" required>
    </div>
    <button type="button" id="btnPreencher" onclick="preencherNoticia()">
      <i class="fas fa-magic"></i> Preencher automaticamente
      <span class="spinner-border spinner-border-sm d-none" id="spinner" role="status"></span>
    </button>

    <div class="field-group">
      <label for="title">üñãÔ∏è T√≠tulo</label>
      <input type="text" name="title" id="title" placeholder="T√≠tulo da not√≠cia" required>
    </div>
    <div class="field-group">
      <label for="description">üìù Descri√ß√£o</label>
      <textarea name="description" id="description" placeholder="Descri√ß√£o breve" required></textarea>
    </div>
    <div class="field-group">
      <label for="source">üè∑Ô∏è Fonte</label>
      <input type="text" name="source" id="source" placeholder="Ex: CNN Brasil" required>
    </div>
    <div class="field-group">
      <label for="image">üì∑ Imagem (URL opcional)</label>
      <input type="url" name="image" id="image" placeholder="Link da imagem">
    </div>
    <div class="field-group">
      <label for="categoria">üè∑Ô∏è Categoria</label>
      <select name="categoria" id="categoria">
        <option value="">Selecione...</option>
        <option value="ia_educacao">üß† IA na Educa√ß√£o</option>
        <option value="ultima_hora">üö® √öltima Hora</option>
        <option value="destaque">üåü Destaque</option>
      </select>
    </div>
    <div class="field-group hidden">
      <label for="keywords">üîë Palavras-chave (SEO)</label>
      <input type="text" name="keywords" id="keywords" placeholder="Ex: IA, educa√ß√£o, inova√ß√£o">
    </div>
    <button type="submit" class="btn-access"><i class="fas fa-save"></i> Salvar Not√≠cia</button>
  </form>

  <hr>
  <h2 class="text-center mb-4">üîç Not√≠cias Cadastradas</h2>

  {% if noticias %}
    <div class="noticia-list">
      {% for noticia in noticias %}
        <div class="noticia-card">
          <img src="{{ noticia.image or url_for('static',filename='img/noticia_padrao.jpg') }}" alt="Imagem">
          <div class="noticia-conteudo">
            <h5>{{ noticia.title }}</h5>
            <div class="tags">
              {% if noticia.categoria %}<span class="tag">{{ noticia.categoria.replace('_',' ')|capitalize }}</span>{% endif %}
            </div>
            <p>{{ noticia.description }}</p>
            <small class="text-muted">Fonte: {{ noticia.source }}</small>
            <div class="card-actions">
              <a href="{{ noticia.url }}" target="_blank" class="btn-access"><i class="fas fa-external-link-alt"></i> Acessar</a>
              <button type="button" class="btn-copy" onclick="navigator.clipboard.writeText('{{ noticia.url }}')"><i class="fas fa-copy"></i> Copiar link</button>
              <button type="button" class="btn-feature{% if noticia.categoria=='destaque' %} active{% endif %}" onclick="toggleFeature({{ loop.index0 }})"><i class="fas fa-star"></i> Destaque</button>
              <a href="/noticias/remover/{{ loop.index0 }}" class="btn-remove" onclick="return confirm('Deseja remover esta not√≠cia?')"><i class="fas fa-trash-alt"></i> Remover</a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted text-center">Nenhuma not√≠cia curada cadastrada ainda.</p>
  {% endif %}
</div>

<script>
  async function preencherNoticia() {
    const url = document.getElementById('url').value;
    if (!url) return alert('Cole um link v√°lido!');
    const spinner = document.getElementById('spinner');
    spinner.classList.remove('d-none');
    try {
      const resp = await fetch('/extrair_info_noticia', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url })
      });
      const data = await resp.json();
      if (data.error) throw new Error(data.error);
      document.getElementById('title').value = data.title || '';
      document.getElementById('description').value = data.description || '';
      document.getElementById('image').value = data.image || '';
      document.getElementById('source').value = data.source || '';
    } catch (err) {
      console.error(err);
      alert('Erro ao extrair dados. Verifique se o link √© v√°lido.');
    } finally {
      spinner.classList.add('d-none');
    }
  }
  function toggleFeature(idx) {
    // Implementar toggle de destaque no backend se desejado
    alert('Recurso de destaque toggled para item ' + idx);
  }
</script>

{% endblock %}
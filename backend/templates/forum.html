{% extends "base.html" %}

{% block title %}F√≥rum - Meu Site IA{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    /* Anima√ß√µes */
    @keyframes fadeInUp { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
    .fade-in { animation: fadeInUp 0.4s ease both; }

    /* Container principal */
    .forum-container { max-width: 1000px; margin: 2rem auto; padding: 1.5rem; }

    /* Banner motivacional */
    .forum-banner { background: linear-gradient(90deg, #007bffee, #20c997cc); color: #fff; padding: 1rem 1.5rem; border-radius: .75rem; margin-bottom: 1.5rem; }
    .forum-banner h4 { margin: 0; font-weight: 600; }
    .forum-banner p { margin: .25rem 0 0; font-size: .95rem; }

    /* Bot√µes prim√°rios e secund√°rios */
    .btn-create { background: #20c997; color: #fff; }
    .btn-create:hover, .btn-create:focus { background: #17a589; color: #fff; }

    .btn-like { font-size: 1rem; color: #888; transition: color .2s; cursor: pointer; }
    .btn-like.liked { color: #dc3545; }
    .btn-like:hover { color: #007bff; }

    /* Cards de t√≥pico */
    .topic-card { border: 1px solid #e2e8f0; border-radius: .75rem; transition: box-shadow .3s; }
    .topic-card:hover { box-shadow: 0 8px 20px rgba(0, 123, 255, 0.2); }
    .topic-card .card-body { animation: fadeInUp 0.3s ease forwards; }
    .topic-card .badge-cat { font-size: .75rem; padding: .35rem .6rem; border-radius: .5rem; text-transform: uppercase; }
    .badge-hot { background: #e55353; }
    .badge-Geral { background: #6c757d; }
    .badge-D√∫vidas\ T√©cnicas { background: #fd7e14; }
    .badge-Projetos { background: #0d6efd; }
    .badge-Sugest√µes { background: #20c997; }

    /* Ranking e conquistas */
    .stats-card { border-radius: .75rem; transition: transform .2s; }
    .stats-card:hover { transform: translateY(-4px); }

    /* Inputs e selects */
    input:focus, select:focus { box-shadow: 0 0 0 .2rem rgba(0, 123, 255, .25); }

    /* T√≠tulos */
    h2.section-title { font-weight: 600; color: #343a40; }
  </style>
{% endblock %}

{% block content %}
<div class="container forum-container">

  <!-- Banner motivacional -->
  <div class="forum-banner text-center mb-4">
    <h4>üöÄ Impulsione sua Aprendizagem!</h4>
    <p>Participe das discuss√µes, troque ideias e conquiste novas vit√≥rias no f√≥rum IA.</p>
  </div>

  <!-- T√≠tulo -->
  <h2 class="section-title mb-4 text-center">üßê F√≥rum Inteligente</h2>

  <!-- Barra de busca, filtros e Nova Discuss√£o -->
  <div class="row g-3 mb-5 align-items-center">
    <div class="col-12 col-md-5 col-lg-4">
      <div class="input-group shadow-sm rounded">
        <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
        <input id="busca-topico" type="text" class="form-control border-start-0" placeholder="Buscar t√≥picos..." oninput="atualizarForum()">
      </div>
    </div>
    <div class="col-6 col-md-3 col-lg-2">
      <select id="filtro-categoria" class="form-select shadow-sm" onchange="atualizarForum()">
        <option value="">Todas Categorias</option>
        <option value="Geral">Geral</option>
        <option value="D√∫vidas T√©cnicas">D√∫vidas T√©cnicas</option>
        <option value="Projetos">Projetos</option>
        <option value="Sugest√µes">Sugest√µes</option>
      </select>
    </div>
    <div class="col-6 col-md-2 col-lg-2">
      <select id="filtro-ordem" class="form-select shadow-sm" onchange="atualizarForum()">
        <option value="recentes">Mais Recentes</option>
        <option value="populares">Mais Populares</option>
        <option value="sem-resposta">Sem Resposta</option>
      </select>
    </div>
    <div class="col-12 col-md-2 text-center text-md-end">
      <button class="btn btn-create w-100 w-md-auto" onclick="abrirNovaDiscussao()">
        <i class="fas fa-plus-circle me-1"></i> Nova Discuss√£o
      </button>
    </div>
  </div>

  <!-- Estat√≠sticas -->
  <div class="row mb-5">
    <div class="col-md-6 mb-3">
      <div class="card stats-card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title"><i class="fas fa-trophy text-warning me-2"></i>Top 3 Usu√°rios</h5>
          <ul class="list-unstyled">
            {% for u in ranking[:3] %}
              <li class="mb-1">{{ loop.index }}. <strong>{{ u.nome }}</strong> ‚Äî {{ u.pontos }} pts</li>
            {% endfor %}
          </ul>
          <a href="{{ url_for('ranking') }}" class="btn btn-outline-primary btn-sm mt-2">Ver Ranking</a>
        </div>
      </div>
    </div>
    <div class="col-md-6 mb-3">
      <div class="card stats-card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title"><i class="fas fa-medal text-info me-2"></i>Suas Conquistas</h5>
          <ul class="list-unstyled">
            {% for m in usuario_logado.medalhas[:5] %}
              <li class="mb-1" title="{{ m.descricao }}">{{ m.icone }} {{ m.nome }}</li>
            {% endfor %}
          </ul>
          <a href="{{ url_for('conquistas') }}" class="btn btn-outline-success btn-sm mt-2">Ver Todas</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista de t√≥picos -->
  {% for topico in topicos %}
    <div class="card mb-3 topic-card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <a href="{{ url_for('ver_topico', id=topico.id) }}" class="h5 text-dark text-truncate">
            {{ topico.titulo }}
          </a>
          {% if topico.curtidas >= 10 %}
            <span class="badge badge-hot">üî• Em Alta</span>
          {% endif %}
        </div>
        <div class="mb-3">
          <span class="badge bg-secondary badge-cat me-1">{{ topico.categoria }}</span>
        </div>
        <p class="text-muted mb-2">
          {{ topico.conteudo[:150] }}{% if topico.conteudo|length > 150 %}...{% endif %}
        </p>
        {% if topico.resumo_ia %}
          <div class="alert alert-info py-2 small mb-3">
            üß† {{ topico.resumo_ia }}
          </div>
        {% endif %}
        <div class="d-flex flex-wrap align-items-center small text-secondary">
          <span class="me-3">Por <strong>{{ topico.usuario.nome }}</strong></span>
          <span class="me-3">{{ topico.data_criacao.strftime('%d/%m/%Y') }}</span>
          <span class="me-3">{{ topico.respostas_count }} respostas</span>
          <i id="btn-like-{{ topico.id }}" class="fas fa-thumbs-up me-1 btn-like" onclick="curtirTopico({{ topico.id }})"></i>
          <span id="likes-{{ topico.id }}" class="me-3">{{ topico.curtidas }}</span>
          {% if usuario_id == topico.usuario.id %}
            {% if (topico.data_criacao + timedelta(hours=24)) > datetime.utcnow() %}
              <button class="btn btn-outline-primary btn-sm me-2"
                      onclick="abrirModalEditarTopico({{ topico.id }}, '{{ topico.titulo|e }}', `{{ topico.conteudo|e }}`, '{{ topico.categoria }}')">
                <i class="fas fa-edit"></i>
              </button>
            {% endif %}
            <form method="POST" action="{{ url_for('excluir_topico', id=topico.id) }}"
                  class="d-inline" onsubmit="return confirm('Tem certeza?');">
              <button type="submit" class="btn btn-outline-danger btn-sm">
                <i class="fas fa-trash"></i>
              </button>
            </form>
          {% endif %}
        </div>
      </div>
    </div>
  {% endfor %}

</div>

<!-- Modal: Nova Discuss√£o -->
<div class="modal fade" id="modalNovaDiscussao" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <form class="modal-content" method="POST" action="{{ url_for('criar_topico') }}">
      <div class="modal-header">
        <h5 class="modal-title">‚ûï Criar Nova Discuss√£o</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="titulo" class="form-label">T√≠tulo</label>
          <input id="titulo" name="titulo" type="text" class="form-control" required maxlength="150">
        </div>
        <div class="mb-3">
          <label for="conteudo" class="form-label">Conte√∫do</label>
          <textarea id="conteudo" name="conteudo" class="form-control" rows="5" required></textarea>
        </div>
        <div class="mb-3">
          <label for="categoria" class="form-label">Categoria</label>
          <select id="categoria" name="categoria" class="form-select" required>
            <option value="Geral">Geral</option>
            <option value="D√∫vidas T√©cnicas">D√∫vidas T√©cnicas</option>
            <option value="Projetos">Projetos</option>
            <option value="Sugest√µes">Sugest√µes</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" type="submit">Criar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Editar T√≥pico -->
<div class="modal fade" id="modalEditarTopico" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <form id="form-editar-topico" class="modal-content" method="POST">
      <div class="modal-header">
        <h5 class="modal-title">‚úèÔ∏è Editar T√≥pico</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="edit_titulo" class="form-label">T√≠tulo</label>
          <input id="edit_titulo" name="titulo" type="text" class="form-control" required maxlength="150">
        </div>
        <div class="mb-3">
          <label for="edit_conteudo" class="form-label">Conte√∫do</label>
          <textarea id="edit_conteudo" name="conteudo" class="form-control" rows="5" required></textarea>
        </div>
        <div class="mb-3">
          <label for="edit_categoria" class="form-label">Categoria</label>
          <select id="edit_categoria" name="categoria" class="form-select" required>
            <option value="Geral">Geral</option>
            <option value="D√∫vidas T√©cnicas">D√∫vidas T√©cnicas</option>
            <option value="Projetos">Projetos</option>
            <option value="Sugest√µes">Sugest√µes</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" type="submit">Salvar</button>
      </div>
    </form>
  </div>
</div>

<script>
  function abrirNovaDiscussao() {
    new bootstrap.Modal(document.getElementById('modalNovaDiscussao')).show();
  }
  function abrirModalEditarTopico(id, titulo, conteudo, categoria) {
    const form = document.getElementById('form-editar-topico');
    form.action = `/forum/editar/${id}`;
    document.getElementById('edit_titulo').value = titulo;
    document.getElementById('edit_conteudo').value = conteudo;
    document.getElementById('edit_categoria').value = categoria;
    new bootstrap.Modal(document.getElementById('modalEditarTopico')).show();
  }
  function curtirTopico(id) {
    fetch(`/forum/curtir/${id}`, { method: 'POST' })
      .then(r => r.json())
      .then(d => {
        document.getElementById(`likes-${id}`).textContent = d.curtidas;
        document.getElementById(`btn-like-${id}`).classList.toggle('liked', d.status === 'curtido');
      });
  }
  function atualizarForum() {
    const params = new URLSearchParams({
      categoria: document.getElementById('filtro-categoria').value,
      ordem: document.getElementById('filtro-ordem').value,
      busca: document.getElementById('busca-topico').value
    });
    window.location = `{{ url_for('forum') }}?${params}`;
  }
</script>
{% endblock %}